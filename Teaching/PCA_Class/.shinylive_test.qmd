---
title: "test"
filters:
  - shinylive
---

```{shinylive-r}
#| standalone: true
#| viewerHeight: 600

library(shiny)
library(bslib)
library(ggplot2)
library(dplyr)
library(patchwork)
library(munsell)

set.seed(248655)

#  UI definition

ui <- page_fluid(
  plotOutput("angleplot"),
  sliderInput(
    "angle",
    "Value of θ in degrees", 
    min     = 0,
    max     = 90,
    value   = 30,
    step    = 5,
    # animate = animationOptions(
    #   interval    = 500,
    #   loop        = FALSE,
    #   playButton  = "PLAY",
    #   pauseButton = "PAUSE"
    # ),
    width   = "100%",
    post    = "°"
  )
)

#  Server logic definition

data <- tibble(
  x = rnorm(30, mean = 5, sd = .5),
  y = 2*x + rnorm(30)
) |>
  mutate(
    scale_x = scale(x)[, 1],
    scale_y = scale(y)[, 1]
  )

server <- function(input, output, session) {
  
  output$angleplot <- renderPlot({
    
    angle_math <- tibble(θ = input$angle*pi/180) |> 
      mutate(
        costheta = cos(θ),
        sintheta = sin(θ)
      )
    
    data_proj <- data |>
      mutate(norm = scale_x*angle_math$costheta + scale_y*angle_math$sintheta) |> 
      mutate(
        x_proj = norm*angle_math$costheta,
        y_proj = norm*angle_math$sintheta
      )
    
    variance <- data_proj |> pull(norm) |> sd()
    MSE <- mean(data_proj$scale_x**2 + data_proj$scale_y**2) - mean(data_proj$norm**2)
    
    p1 <- ggplot(data = data_proj) +
       geom_segment(
          aes(x = scale_x, xend = x_proj, y = scale_y, yend = y_proj),
          linetype = 2,
          colour   = "grey"
        ) +
        geom_abline(
          aes(slope = tan(angle_math$θ), intercept = 0),
          colour = "grey"
          ) +
        geom_point(aes(x = scale_x, y = scale_y)) +
        geom_point(aes(x = x_proj, y = y_proj), colour = "red") +
        annotate(
          geom = "text",
          x = .2, y = -2.5,
          hjust = 0,
          size  = 5.5,
          label = paste("σ[θ]^2 ==", as.character(round(variance, digits = 3))),
          parse = TRUE
        ) +
        coord_fixed(ratio = 1, xlim = c(-2.5, 2.5), ylim = c(-2.5, 2.5)) +
        labs(x = "Trait 1 centré-réduit", y = "Trait 2 centré-réduit") +
        theme_minimal()

      p2 <- ggplot(data = data_proj) +
        geom_segment(
          aes(x = scale_x, xend = x_proj, y = scale_y, yend = y_proj),
          linetype = 1,
          colour   = "red"
        ) +
        geom_abline(
          aes(slope = tan(angle_math$θ), intercept = 0),
          colour = "grey"
        ) +
        geom_point(aes(x = x_proj, y = y_proj), colour = "grey") +
        geom_point(aes(x = scale_x, y = scale_y)) +
        annotate(
          geom = "text",
          x = .2, y = -2.5,
          hjust = 0,
          size  = 5.5,
          label = paste("MSE(θ) =", as.character(round(MSE, digits = 3)))
        ) +
        coord_fixed(ratio = 1, xlim = c(-2.5, 2.5), ylim = c(-2.5, 2.5)) +
        labs(
          x = "Trait 1 centré-réduit"
        ) +
        theme_minimal() +
        theme(axis.title.y = element_blank())

      p1 + p2
  }) 
}

#  Create and Launch Shiny app

shinyApp(ui = ui, server = server)
```